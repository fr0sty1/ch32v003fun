
#include "ch32v003fun.h"
#include "audio.h"
#include <math.h>
#include <stdio.h>

#define PI 3.14159265

char quartersintab[256]={
        0,0,1,2,3,3,4,5,6,7,7,8,9,10,10,11,
        12,13,14,14,15,16,17,18,18,19,20,21,21,22,23,24,
        24,25,26,27,28,28,29,30,31,31,32,33,34,34,35,36,
        37,37,38,39,40,40,41,42,43,43,44,45,46,46,47,48,
        48,49,50,51,51,52,53,54,54,55,56,56,57,58,58,59,
        60,61,61,62,63,63,64,65,65,66,67,67,68,69,69,70,
        71,71,72,73,73,74,74,75,76,76,77,78,78,79,79,80,
        81,81,82,83,83,84,84,85,85,86,87,87,88,88,89,89,
        90,91,91,92,92,93,93,94,94,95,95,96,96,97,97,98,
        98,99,99,100,100,101,101,102,102,103,103,104,104,105,105,105,
        106,106,107,107,108,108,108,109,109,110,110,110,111,111,112,112,
        112,113,113,113,114,114,115,115,115,116,116,116,117,117,117,117,
        118,118,118,119,119,119,119,120,120,120,121,121,121,121,122,122,
        122,122,122,123,123,123,123,123,124,124,124,124,124,125,125,125,
        125,125,125,125,126,126,126,126,126,126,126,126,127,127,127,127,
        127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127
};

char sintab[1024]={
        0,0,1,2,3,3,4,5,6,7,7,8,9,10,10,11,
        12,13,13,14,15,16,17,17,18,19,20,20,21,22,23,24,
        24,25,26,27,27,28,29,30,30,31,32,33,33,34,35,36,
        36,37,38,39,39,40,41,42,42,43,44,44,45,46,47,47,
        48,49,50,50,51,52,52,53,54,55,55,56,57,57,58,59,
        59,60,61,61,62,63,63,64,65,65,66,67,67,68,69,69,
        70,71,71,72,73,73,74,75,75,76,76,77,78,78,79,79,
        80,81,81,82,82,83,84,84,85,85,86,87,87,88,88,89,
        89,90,90,91,91,92,93,93,94,94,95,95,96,96,97,97,
        98,98,99,99,100,100,101,101,102,102,102,103,103,104,104,105,
        105,106,106,106,107,107,108,108,108,109,109,110,110,110,111,111,
        112,112,112,113,113,113,114,114,114,115,115,115,116,116,116,117,
        117,117,117,118,118,118,119,119,119,119,120,120,120,120,121,121,
        121,121,121,122,122,122,122,123,123,123,123,123,123,124,124,124,
        124,124,124,124,125,125,125,125,125,125,125,125,126,126,126,126,
        126,126,126,126,126,126,126,126,126,126,126,126,126,126,126,126,
        127,126,126,126,126,126,126,126,126,126,126,126,126,126,126,126,
        126,126,126,126,126,125,125,125,125,125,125,125,125,124,124,124,
        124,124,124,124,123,123,123,123,123,123,122,122,122,122,121,121,
        121,121,121,120,120,120,120,119,119,119,119,118,118,118,117,117,
        117,117,116,116,116,115,115,115,114,114,114,113,113,113,112,112,
        112,111,111,110,110,110,109,109,108,108,108,107,107,106,106,106,
        105,105,104,104,103,103,102,102,102,101,101,100,100,99,99,98,
        98,97,97,96,96,95,95,94,94,93,93,92,91,91,90,90,
        89,89,88,88,87,87,86,85,85,84,84,83,82,82,81,81,
        80,79,79,78,78,77,76,76,75,75,74,73,73,72,71,71,
        70,69,69,68,67,67,66,65,65,64,63,63,62,61,61,60,
        59,59,58,57,57,56,55,55,54,53,52,52,51,50,50,49,
        48,47,47,46,45,44,44,43,42,42,41,40,39,39,38,37,
        36,36,35,34,33,33,32,31,30,30,29,28,27,27,26,25,
        24,24,23,22,21,20,20,19,18,17,17,16,15,14,13,13,
        12,11,10,10,9,8,7,7,6,5,4,3,3,2,1,0,
        0,0,-1,-2,-3,-3,-4,-5,-6,-7,-7,-8,-9,-10,-10,-11,
        -12,-13,-13,-14,-15,-16,-17,-17,-18,-19,-20,-20,-21,-22,-23,-24,
        -24,-25,-26,-27,-27,-28,-29,-30,-30,-31,-32,-33,-33,-34,-35,-36,
        -36,-37,-38,-39,-39,-40,-41,-42,-42,-43,-44,-44,-45,-46,-47,-47,
        -48,-49,-50,-50,-51,-52,-52,-53,-54,-55,-55,-56,-57,-57,-58,-59,
        -59,-60,-61,-61,-62,-63,-63,-64,-65,-65,-66,-67,-67,-68,-69,-69,
        -70,-71,-71,-72,-73,-73,-74,-75,-75,-76,-76,-77,-78,-78,-79,-79,
        -80,-81,-81,-82,-82,-83,-84,-84,-85,-85,-86,-87,-87,-88,-88,-89,
        -89,-90,-90,-91,-91,-92,-93,-93,-94,-94,-95,-95,-96,-96,-97,-97,
        -98,-98,-99,-99,-100,-100,-101,-101,-102,-102,-102,-103,-103,-104,-104,-105,
        -105,-106,-106,-106,-107,-107,-108,-108,-108,-109,-109,-110,-110,-110,-111,-111,
        -112,-112,-112,-113,-113,-113,-114,-114,-114,-115,-115,-115,-116,-116,-116,-117,
        -117,-117,-117,-118,-118,-118,-119,-119,-119,-119,-120,-120,-120,-120,-121,-121,
        -121,-121,-121,-122,-122,-122,-122,-123,-123,-123,-123,-123,-123,-124,-124,-124,
        -124,-124,-124,-124,-125,-125,-125,-125,-125,-125,-125,-125,-126,-126,-126,-126,
        -126,-126,-126,-126,-126,-126,-126,-126,-126,-126,-126,-126,-126,-126,-126,-126,
        -127,-126,-126,-126,-126,-126,-126,-126,-126,-126,-126,-126,-126,-126,-126,-126,
        -126,-126,-126,-126,-126,-125,-125,-125,-125,-125,-125,-125,-125,-124,-124,-124,
        -124,-124,-124,-124,-123,-123,-123,-123,-123,-123,-122,-122,-122,-122,-121,-121,
        -121,-121,-121,-120,-120,-120,-120,-119,-119,-119,-119,-118,-118,-118,-117,-117,
        -117,-117,-116,-116,-116,-115,-115,-115,-114,-114,-114,-113,-113,-113,-112,-112,
        -112,-111,-111,-110,-110,-110,-109,-109,-108,-108,-108,-107,-107,-106,-106,-106,
        -105,-105,-104,-104,-103,-103,-102,-102,-102,-101,-101,-100,-100,-99,-99,-98,
        -98,-97,-97,-96,-96,-95,-95,-94,-94,-93,-93,-92,-91,-91,-90,-90,
        -89,-89,-88,-88,-87,-87,-86,-85,-85,-84,-84,-83,-82,-82,-81,-81,
        -80,-79,-79,-78,-78,-77,-76,-76,-75,-75,-74,-73,-73,-72,-71,-71,
        -70,-69,-69,-68,-67,-67,-66,-65,-65,-64,-63,-63,-62,-61,-61,-60,
        -59,-59,-58,-57,-57,-56,-55,-55,-54,-53,-52,-52,-51,-50,-50,-49,
        -48,-47,-47,-46,-45,-44,-44,-43,-42,-42,-41,-40,-39,-39,-38,-37,
        -36,-36,-35,-34,-33,-33,-32,-31,-30,-30,-29,-28,-27,-27,-26,-25,
        -24,-24,-23,-22,-21,-20,-20,-19,-18,-17,-17,-16,-15,-14,-13,-13,
        -12,-11,-10,-10,-9,-8,-7,-7,-6,-5,-4,-3,-3,-2,-1,0
};


char getsin(uint16_t a)
{
    uint16_t ai=(a>>6)& 0xff;
    switch (a&0xc000)
    {
        case 0x0000:
            return sintab[ai];
        case 0x4000:
            return sintab[255-ai];
        case 0x8000:
            return -sintab[ai];
        default:
        case 0xc000:
            return -sintab[255-ai];
    }
}

uint16_t deltas[2]={1,2};
uint16_t times[2]={5,10};
AL_Envelope envelope={2,0,deltas,times,1,10,0};

void envelopeupdate(AL_Envelope *this)
{
    if (this->timer) 
    {
        this->volume+=this->delta;
        if (--this->timer==0) 
        {
            if (++this->phase < this->phases) 
            {
                this->delta=this->deltas[this->phase];
                this->timer=this->times[this->phase];
            }
            else
            {
                this->delta=0;
                this->timer=0;
            }
        }
    }
}

uint16_t update(AL_Voice *v)
{
    //v->value=getvalue((v->position+=v->delta)*v->volume)>>8;
    return 0;
}


void updatemix(AL_Mix *this)
{
    uint32_t mixvalue=0;
    for (uint16_t i=0; i!=(AUDIO_VOICES); ++i)
    {
        mixvalue+=this->voices[i].update(&this->voices[i]);
    }
    mixvalue*=this->mastervolume;
    mixvalue>>=8;
}

// initialize audio library
void audio_initialize( void )
{
    printf("Audio initialize");
}

// Audio update
void audio_update( int32_t systime )
{

}

// shutdown audio library and release resources
void audio_release( void )
{
        printf("Audio release");
}


#if 0





#endif